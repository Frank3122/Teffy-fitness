{% extends "base.html" %}
{% load static %}
{% block title %}ADD MEMBERS{% endblock %}

{% block content %}
<main class="app-main">
    <div class="container py-3">
        <div class="row mb-4">
            <div class="col text-center">
                <h2 class="fw-bold text-primary">Add New Member</h2>
                
            </div>
        </div>
        {% if messages %}
<div id="message-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}
    <!--end::App Content Header-->
        <!--begin::App Content-->
        <!-- <div class="container-fluid">
            <div class="row">
         
                <div class="col-md-12">
                    <div class="card card-warning card-outline mb-4">
                        <form id="form" class="mx-2" method="POST" onsubmit="return submitForm();"> -->
                            <!-- {% csrf_token %} -->
                            <!-- <section class="content-header">
                                <div class="container-fluid">
                                    <div class="row mb-2">
                                        <div class="col-sm-6">
                                            <h3>ADD MEMBER</h3>
                                        </div>
                                        <div class="col-sm-6">
                                            <ol class="breadcrumb float-sm-right">
                                                <li class="breadcrumb-item">
                                                    <a href="#">HOME</a>
                                                </li>
                                                <li class="breadcrumb-item active">ADD MEMBER</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                            </section>
                            <section class="content">
                                <div class="container-fluid">
                                    <div class="row">
                                        <div class="col-12"> --> 
                                            <!-- <div class="card card-info card-outline"> -->
                                                <!-- <div class="card-header">
                                                    <h3 class="card-title text-bold text-cyan">ADD NEW MEMBER</h3>
                                                </div> -->
                                                <div class="card shadow-lg">
                                                    <div class="card-body">
                                                        <form id="form" method="POST" onsubmit="return submitForm();">
                                                            {% csrf_token %}
                                                <!-- <form action="" class="form-horizontal" method="POST" onsubmit="return amountSum()">
                                                    {% csrf_token %} -->
                                                    <div class="card-body">
                                                        <div class="card mb-4">
                                                            <!-- <div class="card-header">
                                                                <h5>MEMBER INFORMATION</h5>
                                                            </div> -->
                                                            <div class="mb-4">
                                                                <h4 class="text-secondary">Member Information</h4>
                                                                <hr>
                                                                <div class="row mb-3">
                                                                    <label for="inputName" class="col-sm-3 col-form-label">Member Name</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="name" id="name" placeholder="Enter Name" required minlength="2">
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <label class="col-sm-3 col-form-label">Gender</label>
                                                                    <div class="col-sm-9">
                                                                        <div class="form-check form-check-inline">
                                                                            <input type="radio" class="form-check-input" name="gender" id="Male" value="Male" checked>
                                                                            <label class="form-check-label" for="Male">Male</label>
                                                                        </div>
                                                                        <div class="form-check form-check-inline">
                                                                            <input type="radio" class="form-check-input" name="gender" id="Female" value="Female">
                                                                            <label class="form-check-label" for="Female">Female</label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <label for="inputMobile" class="col-sm-3 col-form-label">Mobile Number</label>
                                                                    <div class="col-sm-5">
                                                                        <input type="text" class="form-control" name="mobile_number" id="mobile_number" minlength="10" maxlength="10" placeholder="Enter Mobile Number" required>
                                                                    </div>
                                                                    <div class="col-sm-4">
                                                                        <select name="countryCode" id="countryCode"  name="countryCode"  class="form-select">
                                                                            <option value="91" data-countrycode="IN" selected>India (+91)</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <label for="aadharnumber" class="col-sm-3 col-form-label">Aadhar Number</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="aadhar_number" id="aadhar_number" minlength="12" maxlength="12" placeholder="Enter Aadhar Number" required>
                                                                    </div>
                                                                </div>
                                                                    
                                                                <div class="row mb-3">
                                                                    <label for="aadharcard" class="col-sm-3 col-form-label">Upload Aadhar Card</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="file" class="form-control" name="filename" id="filename">
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <label for="inputEmail" class="col-sm-3 col-form-label">Email</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="email" class="form-control" name="email" id="email" placeholder="Enter Email">
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <label class="col-sm-3 col-form-label">Date of Birth</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="date" class="form-control" name="date_of_birth" id="date_of_birth">
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <label for="location" class="col-sm-3 col-form-label">Location</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="location" id="location" placeholder="Enter Location">
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <label class="col-sm-3 col-form-label">Member Source</label>
                                                                    <div class="col-sm-9">
                                                                        <select name="source" id="source" class="form-control">
                                                                            <option value="" selected disabled>Select Source</option>
                                                                            <option value="Facebook">Facebook</option>
                                                                            <option value="Friends">Friends</option>
                                                                            <option value="AD">AD</option>
                                                                        </select>
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <label for="inputOccupation" class="col-sm-3 col-form-label">Member Occupation</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="occupation" id="occupation" placeholder="Enter Occupation" autocomplete="off">
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <label class="col-sm-3 col-form-label">Emergency Number</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="emergency_number" id="emergency_number"  placeholder="Enter number" minlength="2" maxlength="10">
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <label for="regAmount" class="col-sm-3 col-form-label">Registration Amount</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="reg_amount" id="reg_amount" value="0" placeholder="Enter Amount">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="card-body shadow-lg ">
                                                            <div class="row mb-3 ">
                                                                <label for="program" class="col-sm-1 col-form-label">Service</label>
                                                                <div class="col-sm-9">
                                                                    <select name="service" class="form-control" id="service" onchange="updateServiceDetails()">
                                                                        <option value="" disabled selected>Select a service</option>
                                                                        <option value="nil">NIL</option> <!-- Adding NIL option -->
                                                                        {% for service in available_services %}
                                                                            <option value="{{ service.id }}" 
                                                                                {% if data.services and service.id == data.services.id %} selected {% endif %} 
                                                                                data-price="{{ service.prices }}" 
                                                                                data-sessions="{{ service.sessions }}" 
                                                                                data-duration="{{ memb_plan.duration }}">
                                                                                {{ service.name }}  
                                                                            </option>
                                                                        {% endfor %}
                                                                    </select>
                                                                    </div>
                                                                    <div class="col-lg-2 col-12 mt-lg-0 mt-2">
                                                                        <a class="btn btn-warning btn-sm" href="{% url 'services' %}" aria-controls="staticBackdrop">
                                                                            Quick Create Package
                                                                        </a>
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <label for="sessions" class="col-sm-3 col-form-label">Total Sessions</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="total_sessions" id="total_sessions" value="{{ total_session }}" readonly>
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <label for="cost_of_plan" class="col-sm-3 col-form-label">Cost of Service</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="cost_of_plan" id="cost_of_plan" value="" readonly>
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <label for="group" class="col-sm-3 col-form-label">Session</label>
                                                                    <div class="col-sm-9">
                                                                        <select name="group" id="group" class="form-control">
                                                                            <option value="" disabled selected>Select a Group</option>
                                                                            {% for group in group %}
                                                                            <option value="{{ group.id }}" {% if data.group and group.id == data.group.id %} selected {% endif %}>
                                                                                {{ group.group }}
                                                                            </option>
                                                                            {% endfor %}
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                
                                                                


                                                                <div class="row mb-3">
                                                                    <label for="select_membership_plan" class="col-sm-3 col-form-label">Membership Plan</label>
                                                                    <div class="col-sm-9">
                                                                        <select name="select_membership_plan" id="select_membership_plan" class="form-control" onchange="calculateExpiry()">
                                                                            <option value="" disabled selected>Select Membership Plan</option>
                                                                            {% for memb_plan in membership_plan %}
                                                                                <option value="{{ memb_plan.id }}" data-duration="{{ memb_plan.duration }}" data-price="{{ memb_plan.price }}">
                                                                                    {{ memb_plan.plan_name }}
                                                                                </option>
                                                                            {% endfor %}
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="row mb-3">
                                                                    <label for="duration" class="col-sm-3 col-form-label">Total Duration</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" id="select_memebrship_plan" name="total_duration" readonly>
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <label for="membership_price" class="col-sm-3 col-form-label">Membership Price</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="membership_price" id="membership_price" value="0.00" readonly>
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <label for="batches" class="col-sm-3 col-form-label">Batch</label>
                                                                    <div class="col-sm-9">
                                                                        <select name="batches" id="batches" class="form-control">
                                                                            <option value="" disabled selected>Select a Batch</option>
                                                                            {% for batch in batches %}  
                                                                            <!-- Assuming batches come from membership_plan -->
                                                                            <option value="{{ batch.id }}">
                                                                                {{ batch.batch }}  <!-- Adjust field name if necessary -->
                                                                            </option>
                                                                            {% endfor %}
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                

                                                                
                                                                

                                                                <div class="row mb-3">
                                                                    <label class="col-lg-3 col-12 col-form-label"></label>
                                                                    <div class="col-lg-9 col-12 d-flex flex-column flex-lg-row">
                                                                        <!-- Discount in Rupees Radio Button -->
                                                                        <div class="form-check form-check-inline">
                                                                            <input type="radio" class="form-check-input" name="discount_type" id="discount_type_money" value="Money" checked onclick="toggleDiscountField()">
                                                                            <label for="discount_type_money" class="form-check-label">Discount in Rupees</label>
                                                                        </div>
                                                                        
                                                                        <!-- Discount in Percentage Radio Button -->
                                                                        <div class="form-check form-check-inline mx-lg-5">
                                                                            <input type="radio" class="form-check-input" name="discount_type" id="discount_type_percentage" value="percentage" onclick="toggleDiscountField()">
                                                                            <label for="discount_type_percentage" class="form-check-label">Discount in Percentage</label>
                                                                            <!-- The Discount Percentage input field -->
                                                                            <input type="text" class="form-check-inline mt-2" name="discountpercentage" id="discountpercentage" min="0" max="100" style="display: none;" placeholder="Enter Discount Percentage">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div class="row mb-3">
                                                                    <label for="cost" class="col-sm-3 col-form-label">Discount on Plan</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="discount" id="discount" placeholder="Enter Amount">
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <label for="cost" class="col-sm-3 col-form-label tex-danger">Conveniance Fees</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" value="0" name="conveniance_fees" id="conveniance_fees" placeholder="Enter Conveniance Amount">
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <label for="totalAmount" class="col-sm-3 col-form-label">Total Amount</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="total_amount" id="total_amount" value="{{ total_amount }}" readonly>
                                                                    </div>
                                                                </div>

<!-- 
                                                                <div class="form-group row">
                                                                    <label class="col-lg-2 col-12 col-form-label"></label>
                                                                    <div class="col-lg-10 col-12 d-flex flex-column flex-lg-row">
                                                                        <div class="custom-control custom-radio">
                                                                            <input type="radio" class="custom-control-input" name="taxType" id="NonGSTbill" value="None" checked="checked">
                                                                            <label for="NonGSTbill" class="custom-control-label">Non Tax Bill</label>
                                                                        </div>
                                                                        <div class="custom-control custom-radio mx-lg-2">
                                                                            <input type="radio" class="custom-control-input" name="taxType" id="Composition" value="Composition">
                                                                            <label for="Composition" class="custom-control-label">GST under Composition</label>
                                                                        </div>
                                                                        <div class="custom-control custom-radio mx-lg-5">
                                                                            <input type="radio" class="custom-control-input" name="taxType" id="GSTBill" value="GST">
                                                                            <label for="GSTBill" class="custom-control-label">GST BILL</label>
                                                                        </div>
                                                                        <div class="custom-control custom-radio">
                                                                            <input type="radio" class="custom-control-input" name="taxType" id="VATBill" value="VAT">
                                                                            <label for="VATBill" class="custom-control-label">VAT Bill
                            
                                                                            </label>
                                                                        </div>
                                                                    </div>
                                                                </div> -->
                                                                <div class="row mb-3" style="display: none;">
                                                                    <label for="taxAmount" class="col-sm-2 col-form-label">GST/VAT Amount</label>
                                                                    <div class="col-sm-10">
                                                                        <input type="text" class="form-control" name="taxAmount" id="taxAmount" placeholder="Enter Amount">
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3 " style="display: none;">
                                                                    <label for="col-sm-3 col-form-label" for="totalPayable">Total Payable Amount</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="totalPayable" id="totalPayable" placeholder="Enter Amount">
                                                                    </div>
                                                                </div>
                                                                <div class="form-group row" style="display: none;">
                                                                    <label for="paid" class="col-sm-2 col-form-label">Earlier Paid Amount</label>
                                                                    <div class="col-sm-10">
                                                                        <input type="text" class="form-control" name="paid" id="paid" placeholder="Enter Amount">
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <label for="EnrollmentDate" class="col-sm-3 col-form-label">Enrollment Date</label>
                                                                    <div class="col-sm-9">
                                                                        <div class="input-group date" data-target-input="nearest">
                                                                            <input type="date" class="from-control hasDatepicker" name="enrollment_date" id="enrollment_date" placeholder="Enter Date" readonly>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <label f class="col-sm-3 col-form-label">Activation Date</label>
                                                                    <div class="col-sm-9">
                                                                        <div class="input-group date" data-target-input="nearest">
                                                                            <input type="date" class="form-control hasDatepicker" name="activation_date" id="activation_date" placeholder="Enter Date" readonly>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <label class="col-sm-3 col-form-label" for="expirydate">Expiry Date</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="expiry_date" id="expiry_date" placeholder="Enter Date" readonly>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="card">
                                                            <div class="card-header">
                                                                <h5>Payment Information</h5>
                                                            </div>
                                                            <div class="card-body">
                                                                <div class="row mb-3">
                                                                    <label for="currentInstallment" class="col-sm-3 col-form-label">Current Installment Amount</label>
                                                                    <div class="col-sm-9">
                                                                        <input type="text" class="form-control" name="current_installment_amount" id="current_installment_amount" placeholder="Enter Amount" oninput="updatePendingAmount()">
                                                                        <br>
                                                                        <span id="pendingSpan">
                                                                            <b style="color: red;">Pending Amount: </b> <b id="pending_amount">0</b>
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                
     
                                                                <div class="row mb-3">
                                                                    <label for="group" class="col-sm-3 col-form-label">Select Online Payment Method</label>
                                                                    <div class="col-sm-9">
                                                                        <select id="payment_mode" class="form-control" name="payment_mode">
                                                                            <option value=""disabled selected>Select Payment Option</option>
                                                                            <option value="cash">CASH</option>
                                                                            <option value="GPAY">GPAY</option>
                                                                            <option value="PhonePe">PhonePe</option>
                                                                            <option value="Netbanking">NetBanking</option>
                                                                        </select>
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <label for="paymentDate" class="col-sm-3 col-form-label">Payment Date</label>
                                                                    <div class="col-sm-9">
                                                                        <div class="input-group date" data-target-input="nearest">
                                                                            <input type="date" class="form-control hasDatepicker" name="payment_date" id="payment_date" placeholder="Payment Date">
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="row mb-3">
                                                                    <label for="group" class="col-sm-3 col-form-label">SOLD BY</label>
                                                                    <div class="col-sm-9">
                                                                        <select name="sold_by" id="sold_by" class="form-control" style="width: 100%;">
                                                                            <option value="" disabled selected>SOLD BY</option>
                                                                            {% for seller in sale_by %}
                                                                                <option value="{{ seller.id }}">{{ seller.user.username }}</option>
                                                                            {% endfor %}
                                                                            
                                                                          
                                                                        </select>
                                                                    </div>
                                                                </div>
                            
                                                                <div class="card-footer text-center">
                                                                    <button type="submit" class="btn btn-info" id="enrollment">ENROLL</button>
                                                                    <br>
                                                                    <span style="color: #f00;font-weight: bold;"></span>
                                                                   
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                        </form>
                                                    </div>
                                                </div>
                                                
    </div>
</main>

                            
           

                            {% endblock content %}
                            
                                
                            {% include "footer.html" %}
                            
                            {% block script %}
                            
                            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                            <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" crossorigin="anonymous"></script>
                            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>
                            <script src="https://cdn.jsdelivr.net/npm/datatables.net/js/jquery.dataTables.min.js"></script>
                            <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.3.0/browser/overlayscrollbars.browser.es6.min.js" crossorigin="anonymous"></script>
                            <script src="/static/js/adminlte.js"></script>
                            <script>
                                // DataTable Initialization for Sales Table
                                $(document).ready(function () {
                                    $('#salesTable').DataTable({
                                        "paging": true,  // Enable pagination
                                        "searching": true,  // Enable searching
                                        "ordering": true,  // Enable ordering
                                        "info": true,  // Display information like "Showing 1 to 10 of 50 entries"
                                        "lengthMenu": [5, 10, 15, 20],  // Customize records per page options
                                        "responsive": true,  // Make the table responsive on smaller screens
                                    });
                                });
                            
                                // OverlayScrollbars Initialization
                                const SELECTOR_SIDEBAR_WRAPPER = ".sidebar-wrapper";
                                const Default = {
                                    scrollbarTheme: "os-theme-light",  
                                    scrollbarAutoHide: "leave",       
                                    scrollbarClickScroll: true,       
                                };

                                // Function to format date as "DD MMM YYYY"
function formatDate(date) {
    var options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(date).toLocaleDateString('en-GB', options); // Display in "DD MMM YYYY" format
}

// Function to update service details (cost of plan, total sessions, etc.)
function updateServiceDetails() {
    var serviceSelect = document.getElementById('service');
    var selectedService = serviceSelect.options[serviceSelect.selectedIndex];
    var price = selectedService.getAttribute('data-price');
    var sessions = selectedService.getAttribute('data-sessions');
    var activation_date = document.getElementById('activation_date');
    var expiry_date = document.getElementById('expiry_date');
    var select_memebrship_plan = document.getElementById('select_memebrship_plan');
    
    // Set the enrollment and activation date to the current date
    var currentDate = new Date();
    var formattedDate = currentDate.toISOString().split('T')[0]; // Format date as YYYY-MM-DD
    activation_date.value = formattedDate; // Set activation date to today's date
    document.getElementById('enrollment_date').value = formattedDate; // Set enrollment date to today's date
    
    // Update cost of plan and total sessions fields
    document.getElementById('cost_of_plan').value = price;
    document.getElementById('total_sessions').value = sessions;
    document.getElementById('select_memebrship_plan').value = duration;
    // Calculate and display the expiry date based on the selected plan's total sessions
    calculateExpiryDate(sessions, currentDate);

    // Recalculate the total amount (initially without discount)
    calculateTotalAmount();
}

// Function to calculate expiry date based on sessions (assuming 1 session per day)
function calculateExpiryDate(sessions, startDate) {
    var expiryDate = new Date(startDate);
    expiryDate.setDate(startDate.getDate() + parseInt(sessions) - 1); // Add sessions to current date
    
    var expiryFormattedDate = expiryDate.toISOString().split('T')[0]; // Format expiry date as YYYY-MM-DD
    document.getElementById('expiry_date').value = expiryFormattedDate; // Set expiry date
}

// Function to toggle discount input visibility based on selected discount type
function toggleDiscountField() {
    var discountTypeMoney = document.getElementById('discount_type_money');
    var discountPercentageField = document.getElementById('discountpercentage');
    
    // Reset the values when discount type changes
    document.getElementById('discount').value = '';
    discountPercentageField.value = '';
    
    // Show or hide the discount percentage input field based on the selected discount type
    if (discountTypeMoney.checked) {
        discountPercentageField.style.display = 'none'; // Hide discount percentage input
    } else {
        discountPercentageField.style.display = 'inline-block'; // Show discount percentage input
    }

    // Recalculate total amount whenever the discount type is changed
    calculateTotalAmount();
}

// Function to calculate and update the total amount
function calculateTotalAmount() {
    var costOfPlan = parseFloat(document.getElementById('cost_of_plan').value) || 0;
    var discountTypeMoney = document.getElementById('discount_type_money');
    var discountTypePercentage = document.getElementById('discount_type_percentage');
    var discountAmount = parseFloat(document.getElementById('discount').value) || 0;
    var discountPercentage = parseFloat(document.getElementById('discountpercentage').value) || 0;
    var convenienceFees = parseFloat(document.getElementById('conveniance_fees').value) || 0;
    var registrationFees = parseFloat(document.getElementById('reg_amount').value) || 0; // Include registration fees
    var totalAmount = costOfPlan;

    // Apply discount based on selected type
    if (discountTypeMoney.checked) {
        totalAmount -= discountAmount;
    } else if (discountTypePercentage.checked) {
        totalAmount -= (costOfPlan * discountPercentage) / 100;
    }

    // Add convenience fees and registration fees to the total amount
    totalAmount += convenienceFees + registrationFees;

    // Update the total amount field
    document.getElementById('total_amount').value = totalAmount.toFixed(2);

    // Update the Current Installment Amount field as well
    var currentInstallmentAmount = totalAmount;
    document.getElementById('current_installment_amount').value = totalAmount.toFixed(2);
}

// Event listeners to trigger total amount calculation on user input
document.getElementById('discount').addEventListener('input', calculateTotalAmount);
document.getElementById('discountpercentage').addEventListener('input', calculateTotalAmount);
document.getElementById('conveniance_fees').addEventListener('input', calculateTotalAmount);
document.getElementById('service').addEventListener('change', updateServiceDetails);
document.getElementById('discount_type_money').addEventListener('change', toggleDiscountField);
document.getElementById('discount_type_percentage').addEventListener('change', toggleDiscountField);

// Trigger updateServiceDetails when the page loads if a default service is selected
window.onload = function() {
    if (document.getElementById('service').value) {
        updateServiceDetails();
    }
};
function updateDuration() {
    var membershipPlanSelect = document.getElementById('select_membership_plan');
    var selectedOption = membershipPlanSelect.options[membershipPlanSelect.selectedIndex];

    if (selectedOption.value) {
        var duration = selectedOption.getAttribute('data-duration'); // Get duration from attribute
        document.getElementById('select_memebrship_plan').value = duration; // Update the duration field
    } else {
        document.getElementById('select_memebrship_plan').value = ''; // Clear if no selection
    }
}

// Ensure the function runs on page load if a plan is already selected
document.addEventListener("DOMContentLoaded", function () {
    updateDuration();
});

    // Function to update Membership Plan details (Duration & Price)
    function updatePlanDetails() {
        var membershipPlanSelect = document.getElementById('select_membership_plan');
        var selectedOption = membershipPlanSelect.options[membershipPlanSelect.selectedIndex];

        if (selectedOption.value) {
            var duration = selectedOption.getAttribute('data-duration'); // Get plan duration
            var price = parseFloat(selectedOption.getAttribute('data-price')) || 0; // Get plan price

            document.getElementById('select_memebrship_plan').value = duration; // Set duration
            document.getElementById('membership_price').value = price.toFixed(2); // Set price

            calculateTotalAmount(); // Recalculate total amount
        } else {
            document.getElementById('select_memebrship_plan').value = ''; // Reset if no selection
            document.getElementById('membership_price').value = '0.00'; 
        }
    }

    // Function to update Service details (Cost, Sessions, Expiry Date)
    function updateServiceDetails() {
        var serviceSelect = document.getElementById('service');
        var selectedService = serviceSelect.options[serviceSelect.selectedIndex];

        if (selectedService.value) {
            var price = parseFloat(selectedService.getAttribute('data-price')) || 0;
            var sessions = parseInt(selectedService.getAttribute('data-sessions')) || 0;
            var activationDate = document.getElementById('activation_date');
            var expiryDate = document.getElementById('expiry_date');

            // Set enrollment and activation date to current date
            var currentDate = new Date();
            var formattedDate = currentDate.toISOString().split('T')[0]; 
            document.getElementById('enrollment_date').value = formattedDate;
            activationDate.value = formattedDate; 

            // Update cost of plan and total sessions
            document.getElementById('cost_of_plan').value = price.toFixed(2);
            document.getElementById('total_sessions').value = sessions;

            // Calculate expiry date
            calculateExpiryDate(sessions, currentDate);
        }
    }

    // Function to calculate expiry date based on sessions (1 session per day)
    function calculateExpiryDate(sessions, startDate) {
        if (sessions > 0) {
            var expiryDate = new Date(startDate);
            expiryDate.setDate(startDate.getDate() + sessions);
            document.getElementById('expiry_date').value = expiryDate.toISOString().split('T')[0];
        }
    }

    function calculateExpiry() {
    let membershipDropdown = document.getElementById("select_membership_plan");
    let selectedOption = membershipDropdown.options[membershipDropdown.selectedIndex];
    let duration = parseInt(selectedOption.getAttribute("data-duration")); // Get plan duration (in months)

    if (duration > 0) {
        let assignedDate = new Date(); // Current date as assigned date
        assignedDate.setMonth(assignedDate.getMonth() + duration); // Add duration to current date

        let expiryDate = assignedDate.toISOString().split('T')[0]; // Convert to YYYY-MM-DD format
        document.getElementById("expiry_date").value = expiryDate;
    } else {
        document.getElementById("expiry_date").value = "";
    }
}

    // Function to toggle discount input visibility based on selected discount type
    function toggleDiscountField() {
        var discountTypeMoney = document.getElementById('discount_type_money');
        var discountPercentageField = document.getElementById('discountpercentage');

        // Reset values
        document.getElementById('discount').value = '';
        discountPercentageField.value = '';

        if (discountTypeMoney.checked) {
            discountPercentageField.style.display = 'none'; 
        } else {
            discountPercentageField.style.display = 'inline-block'; 
        }

        calculateTotalAmount();
    }

    // Function to calculate and update the total amount
    function calculateTotalAmount() {
        var costOfPlan = parseFloat(document.getElementById('cost_of_plan').value) || 0;
        var membershipPrice = parseFloat(document.getElementById('membership_price').value) || 0;
        var discountAmount = parseFloat(document.getElementById('discount').value) || 0;
        var discountPercentage = parseFloat(document.getElementById('discountpercentage').value) || 0;
        var convenienceFees = parseFloat(document.getElementById('conveniance_fees').value) || 0;
        var registrationFees = parseFloat(document.getElementById('reg_amount').value) || 0;

        var totalAmount = costOfPlan + membershipPrice; 

        if (document.getElementById('discount_type_money').checked) {
            totalAmount -= discountAmount;
        } else if (document.getElementById('discount_type_percentage').checked) {
            totalAmount -= (totalAmount * discountPercentage) / 100;
        }

        totalAmount += convenienceFees + registrationFees;

        document.getElementById('total_amount').value = totalAmount.toFixed(2);
        document.getElementById('current_installment_amount').value = totalAmount.toFixed(2);
    }

    // Event listeners
    document.getElementById('select_membership_plan').addEventListener('change', updatePlanDetails);
    document.getElementById('service').addEventListener('change', updateServiceDetails);
    document.getElementById('discount').addEventListener('input', calculateTotalAmount);
    document.getElementById('discountpercentage').addEventListener('input', calculateTotalAmount);
    document.getElementById('conveniance_fees').addEventListener('input', calculateTotalAmount);
    document.getElementById('discount_type_money').addEventListener('change', toggleDiscountField);
    document.getElementById('discount_type_percentage').addEventListener('change', toggleDiscountField);

    // Ensure the details update on page load if a plan is already selected
    document.addEventListener("DOMContentLoaded", function () {
        updatePlanDetails();
        updateServiceDetails();
    });



                                
               
                                
                                document.addEventListener("DOMContentLoaded", function() {
                                    const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
                                    if (sidebarWrapper && typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== "undefined") {
                                        OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
                                            scrollbars: {
                                                theme: Default.scrollbarTheme,
                                                autoHide: Default.scrollbarAutoHide,
                                                clickScroll: Default.scrollbarClickScroll,
                                            },
                                        });
                                    }
                                });
                                function updatePendingAmount() {
    var totalAmount = parseFloat(document.getElementById('total_amount').value) || 0;
    var paidAmount = parseFloat(document.getElementById('current_installment_amount').value) || 0;

    var pendingAmount = totalAmount - paidAmount;

    document.getElementById('pending_amount').textContent = pendingAmount.toFixed(2);
}

// Trigger pending amount update when the page loads
window.onload = function () {
    updatePendingAmount();
};
document.addEventListener("DOMContentLoaded", function () {
    // Automatically hide messages after 5 seconds
    setTimeout(function () {
        let messageContainer = document.getElementById("message-container");
        if (messageContainer) {
            messageContainer.style.transition = "opacity 0.5s";
            messageContainer.style.opacity = "0";
            setTimeout(() => messageContainer.remove(), 500); // Remove after fade out
        }
    }, 5000); // 5 seconds timeout
});
                            </script>
                            {% endblock script %}
                            
